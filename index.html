<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PI-Fuze: Interactive Analysis</title>
    <style>
        :root {
            --primary-color: #4A90E2; --secondary-color: #50E3C2; --bg-color: #F4F6F8;
            --card-bg: #FFFFFF; --text-dark: #333; --text-light: #777; --border-color: #EAECEF;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color); margin: 0; padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; color: var(--primary-color); margin: 0; }
        .header p { font-size: 1.2em; color: var(--text-light); margin-top: 5px; }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .step { flex: 1; text-align: center; padding: 10px; border-bottom: 4px solid var(--border-color); color: var(--text-light); font-weight: bold; }
        .step.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        .card h2 { margin-top: 0; color: var(--text-dark); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .hidden { display: none !important; }
        textarea { width: 100%; min-height: 150px; padding: 15px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; font-family: inherit; resize: vertical; box-sizing: border-box; }
        button { display: block; width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; margin-top: 20px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Analysis Stage Styles */
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .gauge-container { text-align: center; }
        .gauge-container h3 { margin-bottom: 15px; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .comparison-card { background-color: var(--bg-color); padding: 15px; border-radius: 8px; }
        .comparison-card h4 { margin-top: 0; color: var(--primary-color); }

        /* Question Stage Styles */
        .question-card { margin-bottom: 15px; background-color: var(--bg-color); padding: 20px; border-radius: 8px; }
        .question-card label { font-weight: bold; display: block; margin-bottom: 10px; }
        .question-card textarea { min-height: 80px; }

        /* Fusion Stage Styles */
        .fusion-summary { background-color: #eef5ff; border-left: 5px solid var(--primary-color); padding: 20px; border-radius: 8px; }
        .fusion-features ul { list-style-type: '✅'; padding-left: 20px; }
        .fusion-features li { margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>PI-Fuze</h1>
            <p>AI-TA 기반 아이디어 진단 및 융합 시스템</p>
        </div>

        <div class="progress-bar">
            <div class="step active" id="step-1">1. 아이디어 진단</div>
            <div class="step" id="step-2">2. 창의적 도발</div>
            <div class="step" id="step-3">3. 융합 아이디어</div>
        </div>

        <!-- STAGE 1: Initial Idea Input -->
        <div id="stage-input" class="card">
            <h2>아이디어 입력</h2>
            <p>분석하고 싶은 아이디어나 리포트 초안의 핵심 내용을 입력해주세요.</p>
            <textarea id="idea-input" placeholder="여기에 아이디어를 입력하세요..."></textarea>
            <button id="btn-start-analysis">분석 시작</button>
        </div>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="spinner hidden"></div>

        <!-- STAGE 2: Analysis Report -->
        <div id="stage-analysis" class="hidden">
            <div class="card">
                <h2>1. 독창성 진단 리포트</h2>
                <div class="analysis-grid">
                    <div class="gauge-container">
                        <h3>표절 위험도</h3>
                        <svg width="200" height="120" viewBox="0 0 200 120">
                            <defs>
                                <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#50E3C2"/>
                                    <stop offset="50%" stop-color="#F8E71C"/>
                                    <stop offset="100%" stop-color="#D0021B"/>
                                </linearGradient>
                            </defs>
                            <path d="M 20 100 A 80 80 0 0 1 180 100" stroke="#EAECEF" stroke-width="20" fill="none" />
                            <path d="M 20 100 A 80 80 0 0 1 180 100" stroke="url(#gaugeGradient)" stroke-width="20" fill="none" stroke-dasharray="251.2" stroke-dashoffset="251.2" id="gauge-arc"/>
                            <text x="100" y="95" text-anchor="middle" font-size="24" font-weight="bold" fill="#333" id="gauge-text">0%</text>
                            <line x1="100" y1="100" x2="100" y2="20" stroke="#333" stroke-width="4" id="gauge-needle" transform="rotate(-90 100 100)" style="transform-origin: center; transition: transform 0.5s ease-in-out;" />
                        </svg>
                        <p id="plagiarism-reason" style="font-weight: bold;"></p>
                    </div>
                    <div class="archetype-container">
                        <h3>구조적 복제 분석</h3>
                        <p>입력된 아이디어는 <strong id="archetype-name" style="color: var(--primary-color);"></strong> 원형과 유사한 구조를 가집니다.</p>
                        <p id="archetype-desc"></p>
                        <div class="comparison-grid">
                            <div class="comparison-card">
                                <h4>일반적인 사례</h4>
                                <p id="archetype-comparison"></p>
                            </div>
                            <div class="comparison-card">
                                <h4>나의 아이디어</h4>
                                <p>위 사례의 논리 구조를 따라 아이디어를 전개하고 있습니다.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STAGE 3: Question & Answer -->
        <div id="stage-questions" class="card hidden">
            <h2>2. 창의적 도발 질문</h2>
            <p>AI가 제안한 아래 질문들에 답변하며 아이디어를 확장시켜 보세요.</p>
            <div id="questions-container"></div>
            <button id="btn-submit-answers">답변 제출 및 융합 아이디어 생성</button>
        </div>

        <!-- STAGE 4: Fusion Result -->
        <div id="stage-fusion" class="card hidden">
            <h2>3. 최종 융합 아이디어 제안</h2>
            <div class="fusion-summary">
                <h3 id="fusion-title"></h3>
                <p id="fusion-summary"></p>
            </div>
            <h3>연결고리 분석</h3>
            <p id="fusion-connection"></p>
            <div class="fusion-features">
                <h3>주요 특징</h3>
                <ul id="fusion-features-list"></ul>
            </div>
            <button id="btn-restart">새로운 아이디어 분석하기</button>
        </div>
    </div>

<script>
// --- State Management ---
let originalIdea = '';
let aiQuestions = [];
let userAnswers = [];

// --- DOM Elements ---
const stages = {
    input: document.getElementById('stage-input'),
    analysis: document.getElementById('stage-analysis'),
    questions: document.getElementById('stage-questions'),
    fusion: document.getElementById('stage-fusion'),
};
const steps = {
    1: document.getElementById('step-1'),
    2: document.getElementById('step-2'),
    3: document.getElementById('step-3'),
};
const spinner = document.getElementById('loading-spinner');
const ideaInput = document.getElementById('idea-input');
const btnStartAnalysis = document.getElementById('btn-start-analysis');
const btnSubmitAnswers = document.getElementById('btn-submit-answers');
const btnRestart = document.getElementById('btn-restart');

// --- Event Listeners ---
btnStartAnalysis.addEventListener('click', handleAnalysisRequest);
btnSubmitAnswers.addEventListener('click', handleFusionRequest);
btnRestart.addEventListener('click', () => location.reload());

// --- Stage Control ---
function showStage(stageName) {
    Object.values(stages).forEach(stage => stage.classList.add('hidden'));
    if (stages[stageName]) {
        stages[stageName].classList.remove('hidden');
    }
    spinner.classList.add('hidden');

    // Update progress bar
    if (stageName === 'input') {
        steps[1].classList.add('active'); steps[2].classList.remove('active'); steps[3].classList.remove('active');
    } else if (stageName === 'analysis' || stageName === 'questions') {
        steps[1].classList.add('active'); steps[2].classList.add('active'); steps[3].classList.remove('active');
    } else if (stageName === 'fusion') {
        steps[1].classList.add('active'); steps[2].classList.add('active'); steps[3].classList.add('active');
    }
}

// --- API Call Logic ---
async function callApi(body) {
    spinner.classList.remove('hidden');
    Object.values(stages).forEach(stage => stage.classList.add('hidden'));
    btnStartAnalysis.disabled = true;
    btnSubmitAnswers.disabled = true;

    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || `서버 오류: ${response.statusText}`);
        }
        return await response.json();
    } catch (error) {
        alert(`오류가 발생했습니다: ${error.message}`);
        location.reload(); // Reload on error
    } finally {
        spinner.classList.add('hidden');
        btnStartAnalysis.disabled = false;
        btnSubmitAnswers.disabled = false;
    }
}

// --- Step 1: Analysis ---
async function handleAnalysisRequest() {
    originalIdea = ideaInput.value.trim();
    if (!originalIdea) {
        alert('아이디어를 입력해주세요.');
        return;
    }
    const data = await callApi({ stage: 'analyze', idea: originalIdea });
    if (data) {
        renderAnalysisReport(data);
        renderQuestionInputs(data.questions);
        showStage('analysis'); // Show analysis first
        setTimeout(() => { // Then show questions
            stages.analysis.classList.add('hidden');
            showStage('questions');
        }, 5000); // Show analysis for 5 seconds
    }
}

function renderAnalysisReport(data) {
    const { plagiarismScore, plagiarismReason, archetype } = data;
    
    // Gauge update
    const gaugeNeedle = document.getElementById('gauge-needle');
    const gaugeText = document.getElementById('gauge-text');
    const angle = -90 + (plagiarismScore / 100) * 180;
    gaugeNeedle.setAttribute('transform', `rotate(${angle} 100 100)`);
    gaugeText.textContent = `${plagiarismScore}%`;
    document.getElementById('plagiarism-reason').textContent = plagiarismReason;

    // Archetype update
    document.getElementById('archetype-name').textContent = archetype.name;
    document.getElementById('archetype-desc').textContent = archetype.description;
    document.getElementById('archetype-comparison').textContent = archetype.comparison;
}

// --- Step 2: Questions ---
function renderQuestionInputs(questions) {
    aiQuestions = questions;
    const container = document.getElementById('questions-container');
    container.innerHTML = '';
    questions.forEach((q, index) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.innerHTML = `
            <label for="answer-${index}">질문 ${index + 1}: ${q}</label>
            <textarea id="answer-${index}" placeholder="답변을 입력하세요..."></textarea>
        `;
        container.appendChild(card);
    });
}

// --- Step 3: Fusion ---
async function handleFusionRequest() {
    userAnswers = aiQuestions.map((_, index) => {
        const textarea = document.getElementById(`answer-${index}`);
        return textarea.value.trim();
    });

    if (userAnswers.some(answer => answer === '')) {
        alert('모든 질문에 답변해주세요.');
        return;
    }

    const data = await callApi({
        stage: 'fuse',
        originalIdea: originalIdea,
        answers: userAnswers,
    });

    if (data) {
        renderFusionReport(data);
        showStage('fusion');
    }
}

function renderFusionReport(data) {
    const { fusionTitle, fusionSummary, connection, keyFeatures } = data;
    document.getElementById('fusion-title').textContent = fusionTitle;
    document.getElementById('fusion-summary').textContent = fusionSummary;
    document.getElementById('fusion-connection').textContent = connection;
    
    const list = document.getElementById('fusion-features-list');
    list.innerHTML = '';
    keyFeatures.forEach(feature => {
        const li = document.createElement('li');
        li.textContent = feature;
        list.appendChild(li);
    });
}

// --- Initial Load ---
showStage('input');

</script>
</body>
</html>
