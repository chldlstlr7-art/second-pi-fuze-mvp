<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PI-Fuze: Interactive Analysis</title>
    <style>
        :root {
            --primary-color: #3B82F6; /* A richer, more modern blue */
            --secondary-color: #10B981; /* A vibrant green for success/positive elements */
            --bg-color: #F8FAFC; /* A slightly cooler background */
            --card-bg: #FFFFFF;
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --border-color: #E5E7EB;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 {
            font-size: 2.8em;
            font-weight: 800;
            color: var(--text-dark);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .header p { font-size: 1.2em; color: var(--text-light); margin-top: 8px; }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 40px; position: relative; }
        .progress-bar::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 4px; background: var(--border-color); z-index: -1; transform: translateY(-50%);}
        .step { flex: 1; text-align: center; color: var(--text-light); font-weight: bold; position: relative; }
        .step .dot { width: 20px; height: 20px; background-color: var(--border-color); border-radius: 50%; margin: 0 auto 10px; border: 4px solid var(--bg-color); transition: background-color 0.3s ease; }
        .step.active .dot { background-color: var(--primary-color); }
        .step.active { color: var(--primary-color); }
        .card { background-color: var(--card-bg); border-radius: 16px; padding: 35px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 30, 80, 0.08); border: 1px solid var(--border-color); }
        .card h2 { margin-top: 0; color: var(--text-dark); border-bottom: 1px solid var(--border-color); padding-bottom: 15px; font-size: 1.8em; }
        .hidden { display: none !important; }
        textarea { width: 100%; min-height: 150px; padding: 15px; border-radius: 8px; border: 1px solid #D1D5DB; font-size: 16px; font-family: inherit; resize: vertical; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
        textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        button { display: block; width: 100%; padding: 15px; background: linear-gradient(45deg, var(--primary-color), #60A5FA); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top: 20px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        button:disabled { background: #D1D5DB; cursor: not-allowed; transform: none; box-shadow: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Analysis Stage Styles */
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center; }
        .gauge-container { text-align: center; }
        .gauge-container h3 { margin-bottom: 15px; font-size: 1.2em; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .comparison-card { background-color: var(--bg-color); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .comparison-card h4 { margin-top: 0; color: var(--primary-color); font-size: 1.1em;}
        .nav-button-container { text-align: center; margin-top: 20px; }
        #btn-show-questions { width: auto; padding: 12px 30px; display: inline-block; }

        /* Question Stage Styles */
        .question-card { margin-bottom: 20px; background-color: #F9FAFB; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
        .question-card label { font-weight: bold; display: block; margin-bottom: 10px; color: var(--text-dark); }
        .question-card textarea { min-height: 80px; }

        /* Fusion Stage Styles */
        .fusion-summary { background-color: #EFF6FF; border-left: 5px solid var(--primary-color); padding: 20px; border-radius: 8px; margin-bottom: 20px;}
        .fusion-features ul { list-style-type: none; padding-left: 0; }
        .fusion-features li { background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%2310B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>') no-repeat left center; padding-left: 30px; margin-bottom: 15px; line-height: 1.5; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>PI-Fuze</h1>
            <p>AI-TA 기반 아이디어 융합 및 진단 시스템</p>
        </div>

        <div class="progress-bar">
            <div class="step active" id="step-1"><div class="dot"></div>아이디어 진단</div>
            <div class="step" id="step-2"><div class="dot"></div>창의적 도발</div>
            <div class="step" id="step-3"><div class="dot"></div>융합 아이디어</div>
        </div>

        <!-- STAGE 1: Initial Idea Input -->
        <div id="stage-input" class="card">
            <h2>아이디어 입력</h2>
            <p>분석하고 싶은 아이디어나 리포트 초안의 핵심 내용을 입력해주세요.</p>
            <textarea id="idea-input" placeholder="여기에 아이디어를 입력하세요..."></textarea>
            <button id="btn-start-analysis">분석 시작</button>
        </div>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="spinner hidden"></div>

        <!-- STAGE 2: Analysis Report -->
        <div id="stage-analysis" class="hidden">
            <div class="card">
                <h2>1. 독창성 진단 리포트</h2>
                <div class="analysis-grid">
                    <div class="gauge-container">
                        <h3>표절 위험도</h3>
                        <svg width="200" height="120" viewBox="0 0 200 120">
                            <!-- ... SVG Gauge code remains the same ... -->
                            <defs><linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#50E3C2"/><stop offset="50%" stop-color="#F8E71C"/><stop offset="100%" stop-color="#D0021B"/></linearGradient></defs><path d="M 20 100 A 80 80 0 0 1 180 100" stroke="#EAECEF" stroke-width="20" fill="none" /><path d="M 20 100 A 80 80 0 0 1 180 100" stroke="url(#gaugeGradient)" stroke-width="20" fill="none" stroke-dasharray="251.2" stroke-dashoffset="251.2" id="gauge-arc"/><text x="100" y="95" text-anchor="middle" font-size="24" font-weight="bold" fill="#333" id="gauge-text">0%</text><line x1="100" y1="100" x2="100" y2="20" stroke="#333" stroke-width="4" id="gauge-needle" transform="rotate(-90 100 100)" style="transform-origin: center; transition: transform 0.5s ease-in-out;" />
                        </svg>
                        <p id="plagiarism-reason" style="font-weight: bold;"></p>
                    </div>
                    <div class="archetype-container">
                        <h3>구조적 복제 분석</h3>
                        <p>입력된 아이디어는 <strong id="archetype-name" style="color: var(--primary-color);"></strong> 원형과 유사한 구조를 가집니다.</p>
                        <p id="archetype-desc"></p>
                        <div class="comparison-grid">
                            <div class="comparison-card">
                                <h4>일반적인 사례</h4>
                                <p id="archetype-comparison"></p>
                            </div>
                            <div class="comparison-card">
                                <h4>나의 아이디어</h4>
                                <p>위 사례의 논리 구조를 따라 아이디어를 전개하고 있습니다.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="nav-button-container">
                    <button id="btn-show-questions">다음 (질문 답변)</button>
                </div>
            </div>
        </div>

        <!-- STAGE 3: Question & Answer -->
        <div id="stage-questions" class="card hidden">
            <h2>2. 창의적 도발 질문</h2>
            <p>AI가 제안한 아래 질문들에 답변하며 아이디어를 확장시켜 보세요.</p>
            <div id="questions-container"></div>
            <button id="btn-submit-answers">답변 제출 및 융합 아이디어 생성</button>
        </div>

        <!-- STAGE 4: Fusion Result -->
        <div id="stage-fusion" class="card hidden">
            <h2>3. 최종 융합 아이디어 제안</h2>
            <div class="fusion-summary">
                <h3 id="fusion-title" style="color: var(--primary-color);"></h3>
                <p id="fusion-summary"></p>
            </div>
            <h3>연결고리 분석</h3>
            <p id="fusion-connection"></p>
            <div class="fusion-features">
                <h3>주요 특징</h3>
                <ul id="fusion-features-list"></ul>
            </div>
            <button id="btn-restart">새로운 아이디어 분석하기</button>
        </div>
    </div>

<script>
// --- State Management ---
let originalIdea = '';
let aiQuestions = [];
let userAnswers = [];

// --- DOM Elements ---
const stages = {
    input: document.getElementById('stage-input'),
    analysis: document.getElementById('stage-analysis'),
    questions: document.getElementById('stage-questions'),
    fusion: document.getElementById('stage-fusion'),
};
const steps = {
    1: document.getElementById('step-1'),
    2: document.getElementById('step-2'),
    3: document.getElementById('step-3'),
};
const spinner = document.getElementById('loading-spinner');
const ideaInput = document.getElementById('idea-input');
const btnStartAnalysis = document.getElementById('btn-start-analysis');
const btnShowQuestions = document.getElementById('btn-show-questions');
const btnSubmitAnswers = document.getElementById('btn-submit-answers');
const btnRestart = document.getElementById('btn-restart');

// --- Event Listeners ---
btnStartAnalysis.addEventListener('click', handleAnalysisRequest);
btnShowQuestions.addEventListener('click', () => showStage('questions'));
btnSubmitAnswers.addEventListener('click', handleFusionRequest);
btnRestart.addEventListener('click', () => location.reload());

// --- Stage Control ---
function showStage(stageName) {
    Object.values(stages).forEach(stage => stage.classList.add('hidden'));
    if (stages[stageName]) {
        stages[stageName].classList.remove('hidden');
    }
    spinner.classList.add('hidden');

    // Update progress bar
    steps[1].classList.remove('active');
    steps[2].classList.remove('active');
    steps[3].classList.remove('active');

    if (stageName === 'input' || stageName === 'analysis') {
        steps[1].classList.add('active');
    } else if (stageName === 'questions') {
        steps[1].classList.add('active');
        steps[2].classList.add('active');
    } else if (stageName === 'fusion') {
        steps[1].classList.add('active');
        steps[2].classList.add('active');
        steps[3].classList.add('active');
    }
}

// --- API Call Logic ---
async function callApi(body) {
    spinner.classList.remove('hidden');
    Object.values(stages).forEach(stage => stage.classList.add('hidden'));
    btnStartAnalysis.disabled = true;
    btnSubmitAnswers.disabled = true;

    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || `서버 오류: ${response.statusText}`);
        }
        return await response.json();
    } catch (error) {
        alert(`오류가 발생했습니다: ${error.message}`);
        location.reload(); // Reload on error
    } finally {
        spinner.classList.add('hidden');
        btnStartAnalysis.disabled = false;
        btnSubmitAnswers.disabled = false;
    }
}

// --- Step 1: Analysis ---
async function handleAnalysisRequest() {
    originalIdea = ideaInput.value.trim();
    if (!originalIdea) {
        alert('아이디어를 입력해주세요.');
        return;
    }
    const data = await callApi({ stage: 'analyze', idea: originalIdea });
    if (data) {
        renderAnalysisReport(data);
        renderQuestionInputs(data.questions);
        showStage('analysis'); // Show analysis and wait for user action
    }
}

function renderAnalysisReport(data) {
    const { plagiarismScore, plagiarismReason, archetype } = data;
    
    // Gauge update
    const gaugeNeedle = document.getElementById('gauge-needle');
    const gaugeText = document.getElementById('gauge-text');
    const angle = -90 + (plagiarismScore / 100) * 180;
    gaugeNeedle.setAttribute('transform', `rotate(${angle} 100 100)`);
    gaugeText.textContent = `${plagiarismScore}%`;
    document.getElementById('plagiarism-reason').textContent = plagiarismReason;

    // Archetype update
    document.getElementById('archetype-name').textContent = archetype.name;
    document.getElementById('archetype-desc').textContent = archetype.description;
    document.getElementById('archetype-comparison').textContent = archetype.comparison;
}

// --- Step 2: Questions ---
function renderQuestionInputs(questions) {
    aiQuestions = questions;
    const container = document.getElementById('questions-container');
    container.innerHTML = '';
    questions.forEach((q, index) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.innerHTML = `
            <label for="answer-${index}">질문 ${index + 1}: ${q}</label>
            <textarea id="answer-${index}" placeholder="답변을 입력하세요..."></textarea>
        `;
        container.appendChild(card);
    });
}

// --- Step 3: Fusion ---
async function handleFusionRequest() {
    userAnswers = aiQuestions.map((_, index) => {
        const textarea = document.getElementById(`answer-${index}`);
        return textarea.value.trim();
    });

    if (userAnswers.some(answer => answer === '')) {
        alert('모든 질문에 답변해주세요.');
        return;
    }

    const data = await callApi({
        stage: 'fuse',
        originalIdea: originalIdea,
        answers: userAnswers,
    });

    if (data) {
        renderFusionReport(data);
        showStage('fusion');
    }
}

function renderFusionReport(data) {
    const { fusionTitle, fusionSummary, connection, keyFeatures } = data;
    document.getElementById('fusion-title').textContent = fusionTitle;
    document.getElementById('fusion-summary').textContent = fusionSummary;
    document.getElementById('fusion-connection').textContent = connection;
    
    const list = document.getElementById('fusion-features-list');
    list.innerHTML = '';
    keyFeatures.forEach(feature => {
        const li = document.createElement('li');
        li.textContent = feature;
        list.appendChild(li);
    });
}

// --- Initial Load ---
showStage('input');

</script>
</body>
</html>

