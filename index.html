<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PI-Fuze: Interactive Analysis</title>
    <style>
        :root {
            --primary-color: #3B82F6; /* A richer, more modern blue */
            --secondary-color: #10B981; /* A vibrant green for success/positive elements */
            --warning-color: #F59E0B; /* Amber for similarity points */
            --bg-color: #F8FAFC; /* A slightly cooler background */
            --card-bg: #FFFFFF;
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --border-color: #E5E7EB;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 {
            font-size: 2.5em;
            font-weight: 800;
            color: var(--text-dark);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .header p { font-size: 1.1em; color: var(--text-light); margin-top: 8px; }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 40px; position: relative; }
        .progress-bar::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 4px; background: var(--border-color); z-index: -1; transform: translateY(-50%);}
        .step { flex: 1; text-align: center; color: var(--text-light); font-weight: bold; position: relative; }
        .step .dot { width: 20px; height: 20px; background-color: var(--border-color); border-radius: 50%; margin: 0 auto 10px; border: 4px solid var(--bg-color); transition: background-color 0.3s ease; }
        .step.active .dot { background-color: var(--primary-color); }
        .step.active { color: var(--primary-color); }
        .card { 
            background-color: var(--card-bg); 
            border-radius: 16px; 
            padding: 35px; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 32px rgba(0, 30, 80, 0.08); 
            border: 1px solid var(--border-color);
            animation: fadeIn 0.5s ease-in-out;
        }
        .hidden { display: none !important; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        textarea { width: 100%; min-height: 150px; padding: 15px; border-radius: 8px; border: 1px solid #D1D5DB; font-size: 16px; font-family: inherit; resize: vertical; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
        textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        
        button { display: block; width: 100%; padding: 15px; background: linear-gradient(45deg, var(--primary-color), #60A5FA); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top: 20px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        button:disabled { background: #D1D5DB; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Analysis Stage Styles */
        h3 { font-size: 1.4em; color: var(--text-dark); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); }
        .analysis-section { margin-bottom: 30px; }
        .criteria-list { list-style: none; padding-left: 0; display: flex; flex-wrap: wrap; gap: 10px; }
        .criteria-list li { background-color: #EFF6FF; color: var(--primary-color); padding: 8px 15px; border-radius: 20px; font-size: 0.9em; font-weight: 500; }
        
        .analysis-grid { display: grid; grid-template-columns: 1fr; gap: 30px; margin-top: 20px; }
        .gauge-container { text-align: center; }
        
        .comparison-card { background-color: var(--bg-color); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .comparison-card h4 { margin-top: 0; color: var(--primary-color); font-size: 1.2em;}
        
        .comparison-point { margin-top: 20px; padding: 20px; border-radius: 8px; }
        .comparison-point.similar { background-color: #FFFBEB; border-left: 5px solid var(--warning-color); }
        .comparison-point.different { background-color: #ECFDF5; border-left: 5px solid var(--secondary-color); }
        .comparison-point h4 { display: flex; align-items: center; gap: 10px; margin-top: 0; font-size: 1.1em; }
        .comparison-point.similar h4 { color: #D97706; }
        .comparison-point.different h4 { color: #059669; }

        .nav-button-container { text-align: center; margin-top: 20px; }
        #btn-show-questions { width: auto; padding: 12px 30px; display: inline-block; background: var(--secondary-color) }

        /* Question Stage Styles */
        .question-card { margin-bottom: 20px; background-color: #F9FAFB; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
        .question-card label { font-weight: bold; display: block; margin-bottom: 10px; color: var(--text-dark); }
        .question-card textarea { min-height: 80px; }

        /* Fusion Stage Styles & New Buttons */
        .fusion-summary { background-color: #EFF6FF; border-left: 5px solid var(--primary-color); padding: 20px; border-radius: 8px; margin-bottom: 20px;}
        .fusion-features ul { list-style-type: none; padding-left: 0; }
        .fusion-features li { background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%2310B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>') no-repeat left center; padding-left: 30px; margin-bottom: 15px; line-height: 1.5; }
        
        .action-buttons-container { margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        #btn-copy-result { background: var(--secondary-color); margin-bottom: 20px; }
        .feedback-section { text-align: center; }
        .feedback-section p { font-weight: bold; color: var(--text-light); margin-bottom: 10px;}
        .feedback-buttons { display: flex; justify-content: center; gap: 15px; }
        .feedback-btn { width: 80px; padding: 10px; font-size: 24px; background: none; border: 2px solid var(--border-color); border-radius: 50px; transition: background-color 0.2s, transform 0.2s; margin: 0; }
        .feedback-btn:hover { background-color: #f0f0f0; transform: scale(1.1); }
        .feedback-btn.selected { background-color: var(--secondary-color); border-color: var(--secondary-color); color: white; }

        .btn-secondary { background: var(--bg-color); color: var(--text-dark); border: 1px solid var(--border-color); margin-top: 10px !important; }
        .btn-secondary:hover { background: #F3F4F6; box-shadow: none; transform: none; }

        @media (min-width: 768px) {
            .analysis-grid { grid-template-columns: 220px 1fr; align-items: flex-start; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>PI-Fuze</h1>
            <p>AI-TA 기반 아이디어 진단 및 융합 시스템</p>
        </div>

        <div class="progress-bar">
            <div class="step active" id="step-1"><div class="dot"></div>아이디어 진단</div>
            <div class="step" id="step-2"><div class="dot"></div>창의적 도발</div>
            <div class="step" id="step-3"><div class="dot"></div>융합 아이디어</div>
        </div>

        <!-- STAGE 1: Initial Idea Input -->
        <div id="stage-input" class="card">
            <h2>아이디어 입력</h2>
            <p>분석하고 싶은 아이디어나 리포트 초안의 핵심 내용을 입력해주세요.</p>
            <textarea id="idea-input" placeholder="여기에 아이디어를 입력하세요..."></textarea>
            <button id="btn-start-analysis">분석 시작</button>
            <button id="btn-show-example" class="btn-secondary">예시 결과 보기</button>
        </div>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="spinner hidden"></div>

        <!-- STAGE 2: Analysis Report -->
        <div id="stage-analysis" class="card hidden">
            <h2>1. 독창성 진단 리포트</h2>
            
            <div class="analysis-section">
                <h3>종합 평가</h3>
                <p id="overall-assessment"></p>
            </div>
            
            <div class="analysis-grid">
                <div class="gauge-container">
                    <h3>구조적 독창성</h3>
                    <svg width="200" height="120" viewBox="0 0 200 120">
                        <defs><linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#D0021B"/><stop offset="50%" stop-color="#F8E71C"/><stop offset="100%" stop-color="#50E3C2"/></linearGradient></defs><path d="M 20 100 A 80 80 0 0 1 180 100" stroke="#EAECEF" stroke-width="20" fill="none" /><path d="M 20 100 A 80 80 0 0 1 180 100" stroke="url(#gaugeGradient)" stroke-width="20" fill="none" stroke-dasharray="251.2" stroke-dashoffset="251.2" id="gauge-arc"/><text x="100" y="95" text-anchor="middle" font-size="24" font-weight="bold" fill="#333" id="gauge-text">0%</text><line x1="100" y1="100" x2="100" y2="20" stroke="#333" stroke-width="4" id="gauge-needle" transform="rotate(-90 100 100)" style="transform-origin: center; transition: transform 0.5s ease-in-out;" />
                    </svg>
                </div>
                <div class="criteria-container">
                    <h3>판단 기준</h3>
                    <ul id="criteria-list" class="criteria-list"></ul>
                </div>
            </div>

            <div class="analysis-section">
                <h3>유사 사례 심층 분석</h3>
                <div class="comparison-card">
                    <h4>유사사례: <span id="comparison-name" style="font-weight:bold;"></span></h4>
                    <p id="comparison-desc"></p>
                </div>
                <div class="comparison-point similar">
                    <h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                        구조적 유사점
                    </h4>
                    <p id="points-similarity"></p>
                </div>
                <div class="comparison-point different">
                    <h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                        차별점 및 독창성
                    </h4>
                    <p id="points-difference"></p>
                </div>
            </div>
            
            <div class="nav-button-container">
                <button id="btn-show-questions">다음 (질문 답변)</button>
            </div>
        </div>

        <!-- STAGE 3: Question & Answer -->
        <div id="stage-questions" class="card hidden">
            <h2>2. 창의적 도발 질문</h2>
            <p>AI가 제안한 아래 질문들에 답변하며 아이디어를 확장시켜 보세요.</p>
            <div id="questions-container"></div>
            <button id="btn-submit-answers">답변 제출 및 융합 아이디어 생성</button>
        </div>

        <!-- STAGE 4: Fusion Result -->
        <div id="stage-fusion" class="card hidden">
            <h2>3. 최종 융합 아이디어 제안</h2>
            <div class="fusion-summary">
                <h3 id="fusion-title" style="color: var(--primary-color);"></h3>
                <p id="fusion-summary-text"></p>
            </div>
            <h3>연결고리 분석</h3>
            <p id="fusion-connection"></p>
            <div class="fusion-features">
                <h3>주요 특징</h3>
                <ul id="fusion-features-list"></ul>
            </div>
            
            <div class="action-buttons-container">
                <button id="btn-copy-result">결과 텍스트로 복사</button>
                <div class="feedback-section">
                    <p>이 제안이 도움이 되었나요?</p>
                    <div class="feedback-buttons">
                        <button class="feedback-btn" id="btn-feedback-yes">👍</button>
                        <button class="feedback-btn" id="btn-feedback-no">👎</button>
                    </div>
                    <p id="feedback-message" style="color: var(--secondary-color); font-weight: bold; margin-top: 10px;"></p>
                </div>
            </div>

            <button id="btn-restart">새로운 아이디어 분석하기</button>
        </div>
    </div>

<script>
// --- State Management ---
let originalIdea = '';
let aiQuestions = [];
let userAnswers = [];
let fusionResultForCopy = '';

// --- DOM Elements ---
const stages = {
    input: document.getElementById('stage-input'),
    analysis: document.getElementById('stage-analysis'),
    questions: document.getElementById('stage-questions'),
    fusion: document.getElementById('stage-fusion'),
};
const steps = {
    1: document.getElementById('step-1'),
    2: document.getElementById('step-2'),
    3: document.getElementById('step-3'),
};
const spinner = document.getElementById('loading-spinner');
const ideaInput = document.getElementById('idea-input');
const btnStartAnalysis = document.getElementById('btn-start-analysis');
const btnShowQuestions = document.getElementById('btn-show-questions');
const btnSubmitAnswers = document.getElementById('btn-submit-answers');
const btnRestart = document.getElementById('btn-restart');
const btnCopyResult = document.getElementById('btn-copy-result');
const btnFeedbackYes = document.getElementById('btn-feedback-yes');
const btnFeedbackNo = document.getElementById('btn-feedback-no');
const feedbackMessage = document.getElementById('feedback-message');
const btnShowExample = document.getElementById('btn-show-example');

// --- Event Listeners ---
btnStartAnalysis.addEventListener('click', handleAnalysisRequest);
btnShowQuestions.addEventListener('click', () => showStage('questions'));
btnSubmitAnswers.addEventListener('click', handleFusionRequest);
btnRestart.addEventListener('click', () => location.reload());
btnCopyResult.addEventListener('click', handleCopyResult);
btnFeedbackYes.addEventListener('click', () => handleFeedback(true));
btnFeedbackNo.addEventListener('click', () => handleFeedback(false));
btnShowExample.addEventListener('click', handleShowExample);

// --- Stage Control ---
function showStage(stageName) {
    Object.values(stages).forEach(stage => stage.classList.add('hidden'));
    if (stages[stageName]) {
        stages[stageName].classList.remove('hidden');
    }
    spinner.classList.add('hidden');

    // Update progress bar
    Object.values(steps).forEach(step => step.classList.remove('active'));

    if (stageName === 'input' || stageName === 'analysis') {
        steps[1].classList.add('active');
    } else if (stageName === 'questions') {
        steps[1].classList.add('active');
        steps[2].classList.add('active');
    } else if (stageName === 'fusion') {
        [steps[1], steps[2], steps[3]].forEach(s => s.classList.add('active'));
    }
}

// --- API Call Logic ---
async function callApi(body) {
    spinner.classList.remove('hidden');
    Object.values(stages).forEach(stage => stage.classList.add('hidden'));
    [btnStartAnalysis, btnSubmitAnswers].forEach(btn => btn.disabled = true);

    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || `서버 오류: ${response.statusText}`);
        }
        return await response.json();
    } catch (error) {
        alert(`오류가 발생했습니다: ${error.message}`);
        location.reload();
    } finally {
        spinner.classList.add('hidden');
        [btnStartAnalysis, btnSubmitAnswers].forEach(btn => btn.disabled = false);
    }
}

// --- Step 1: Analysis ---
async function handleAnalysisRequest() {
    originalIdea = ideaInput.value.trim();
    if (!originalIdea) {
        alert('아이디어를 입력해주세요.');
        return;
    }
    const data = await callApi({ stage: 'analyze', idea: originalIdea });
    if (data) {
        renderAnalysisReport(data);
        renderQuestionInputs(data.questions);
        showStage('analysis');
    }
}

function renderAnalysisReport(data) {
    const { originalityScore, overallAssessment, judgmentCriteria, comparisonAnalysis } = data;
    
    // Render Gauge
    const gaugeNeedle = document.getElementById('gauge-needle');
    const gaugeText = document.getElementById('gauge-text');
    const angle = -90 + (originalityScore / 100) * 180;
    gaugeNeedle.setAttribute('transform', `rotate(${angle} 100 100)`);
    gaugeText.textContent = `${originalityScore}%`;

    // Render Texts
    document.getElementById('overall-assessment').textContent = overallAssessment;
    
    // Render Criteria
    const criteriaList = document.getElementById('criteria-list');
    criteriaList.innerHTML = '';
    judgmentCriteria.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        criteriaList.appendChild(li);
    });

    // Render Comparison
    document.getElementById('comparison-name').textContent = comparisonAnalysis.existingExampleName;
    document.getElementById('comparison-desc').textContent = comparisonAnalysis.existingExampleDesc;
    document.getElementById('points-similarity').textContent = comparisonAnalysis.pointsOfSimilarity;
    document.getElementById('points-difference').textContent = comparisonAnalysis.pointsOfDifference;
}


// --- Step 2: Questions ---
function renderQuestionInputs(questions) {
    aiQuestions = questions;
    const container = document.getElementById('questions-container');
    container.innerHTML = '';
    questions.forEach((q, index) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.innerHTML = `<label for="answer-${index}">질문 ${index + 1}: ${q}</label><textarea id="answer-${index}" placeholder="답변을 입력하세요..."></textarea>`;
        container.appendChild(card);
    });
}

// --- Step 3: Fusion ---
async function handleFusionRequest() {
    userAnswers = aiQuestions.map((_, index) => document.getElementById(`answer-${index}`).value.trim());
    if (userAnswers.some(answer => answer === '')) {
        alert('모든 질문에 답변해주세요.');
        return;
    }
    const data = await callApi({ stage: 'fuse', originalIdea: originalIdea, answers: userAnswers });
    if (data) {
        renderFusionReport(data);
        showStage('fusion');
    }
}

function renderFusionReport(data) {
    const { fusionTitle, fusionSummary, connection, keyFeatures } = data;
    document.getElementById('fusion-title').textContent = fusionTitle;
    document.getElementById('fusion-summary-text').textContent = fusionSummary;
    document.getElementById('fusion-connection').textContent = connection;
    
    const list = document.getElementById('fusion-features-list');
    list.innerHTML = '';
    keyFeatures.forEach(feature => {
        const li = document.createElement('li');
        li.textContent = feature;
        list.appendChild(li);
    });

    // Prepare text for copying
    fusionResultForCopy = `## 융합 아이디어: ${fusionTitle}\n\n**요약:**\n${fusionSummary}\n\n**연결고리 분석:**\n${connection}\n\n**주요 특징:**\n${keyFeatures.map(f => `- ${f}`).join('\n')}`;
}

// --- New Feature Functions ---
function handleCopyResult() {
    navigator.clipboard.writeText(fusionResultForCopy).then(() => {
        const originalText = btnCopyResult.textContent;
        btnCopyResult.textContent = '복사 완료!';
        btnCopyResult.disabled = true;
        setTimeout(() => {
            btnCopyResult.textContent = originalText;
            btnCopyResult.disabled = false;
        }, 2000);
    }).catch(err => {
        console.error('Copy failed', err);
        alert('복사에 실패했습니다.');
    });
}

function handleFeedback(isHelpful) {
    feedbackMessage.textContent = '피드백을 주셔서 감사합니다!';
    btnFeedbackYes.disabled = true;
    btnFeedbackNo.disabled = true;
    btnFeedbackYes.classList.remove('selected');
    btnFeedbackNo.classList.remove('selected');
    if (isHelpful) {
        btnFeedbackYes.classList.add('selected');
    } else {
        btnFeedbackNo.classList.add('selected');
    }
}

// --- Example Result Function ---
function handleShowExample() {
    const exampleData = {
        fusionTitle: "드림스케이프(DreamScape): AI 기반 꿈 분석을 통한 개인 맞춤형 멘탈 케어 솔루션",
        fusionSummary: "드림스케이프는 사용자가 기록한 꿈의 서사와 상징을 AI로 분석하여 무의식적인 심리 상태에 대한 통찰을 제공하는 멘탈 케어 솔루션입니다. 단순한 꿈 해몽을 넘어, 저명한 심리학 이론(예: 융의 분석심리학)을 기반으로 꿈의 패턴과 현실의 감정 변화 사이의 연관성을 시각화하여 보여줍니다. 이를 통해 사용자는 스스로를 더 깊이 이해하고, 스트레스나 불안의 근본적인 원인을 탐색하는 새로운 경로를 발견할 수 있습니다.",
        connection: "초기 아이디어는 'AI 기반 꿈 일기'였습니다. 그러나 '단순 데이터 기록 및 분석'이라는 구조는 이미 '무드 트래커'나 '헬스케어 앱'에서 널리 사용되는 구조라는 피드백을 반영했습니다. 따라서 사용자의 답변을 통해 '전문 심리학 이론 접목'과 '현실 감정과의 연관성 시각화'라는 요소를 융합하여, 단순 분석을 넘어 구체적인 '멘탈 케어 솔루션'으로 아이디어를 발전시켰습니다. 이는 기존 앱들과의 구조적 유사성을 극복하고 명확한 차별점을 확보하는 핵심적인 진화입니다.",
        keyFeatures: [
            "상징 분석 엔진: 사용자가 입력한 꿈의 텍스트와 이미지를 분석하여 핵심 상징을 추출하고, 융의 분석심리학 이론에 기반한 다각적인 해석을 제공합니다.",
            "감정-꿈 연관성 대시보드: 사용자가 기록한 현실의 감정 상태와 꿈의 내용을 교차 분석하여, 특정 감정이 어떤 꿈의 패턴으로 나타나는지 시각적인 그래프와 리포트로 보여줍니다.",
            "개인화된 자아 탐색 퀘스트: 분석 결과를 바탕으로 '나의 불안과 마주하기', '내 안의 창의성 발견하기' 등 개인 맞춤형 성찰 질문과 활동(퀘스트)을 제안하여 지속적인 멘탈 케어를 돕습니다."
        ]
    };
    renderFusionReport(exampleData);
    showStage('fusion');
}


// --- Initial Load ---
showStage('input');
</script>
</body>
</html>

